{% extends "base.html" %}

{% block title %}Vis√£o Geral{% endblock %}
{% block page_title %}Vis√£o Geral de Monitoramento{% endblock %}
{% block page_subtitle %}<p class="topbar-subtitle">Bem-vindo, {{ admin.full_name }}</p>{% endblock %}

{% block content %}

<!-- 1. SE√á√ÉO DE TR√ÅFEGO DE INTERNET -->
<div class="mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold flex items-center gap-2">
            üåê Tr√°fego de Internet (Hoje)
        </h2>
        <a href="{{ url_for('admin.monitoring_dashboard') }}" class="btn btn-sm btn-outline">
            Ver Detalhes ‚Üí
        </a>
    </div>

    <div class="stats-grid">
        <div class="stat-card stat-primary">
            <div class="stat-icon primary">üìâ</div>
            <div class="stat-label">Total de Requisi√ß√µes</div>
            <div class="stat-value">{{ "{:,}".format(traffic_stats.total_requests).replace(',', '.') }}</div>
        </div>

        <div class="stat-card stat-error">
            <div class="stat-icon error">üõ°Ô∏è</div>
            <div class="stat-label">Bloqueios de Seguran√ßa</div>
            <div class="stat-value">{{ "{:,}".format(traffic_stats.blocked_requests).replace(',', '.') }}</div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon warning">üèÜ</div>
            <div class="stat-label">Top Usu√°rio</div>
            <div class="stat-value text-lg">{{ traffic_stats.top_user }}</div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon success">üõ∞Ô∏è</div>
            <div class="stat-label">Agentes Ativos</div>
            <div class="stat-value">{{ stats.online_agents }} <span style="font-size: 0.8rem; opacity: 0.5;">/ {{
                    stats.managed_devices }}</span></div>
        </div>
    </div>
</div>

<!-- 2. SE√á√ÉO DE SERVIDORES NAS -->
<div class="mb-8">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold flex items-center gap-2">
            üñ•Ô∏è Servidores de Arquivos NAS
        </h2>
        <a href="{{ url_for('admin.file_servers') }}" class="btn btn-sm btn-outline">
            Gerenciar ‚Üí
        </a>
    </div>

    {% if nas_servers %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for server in nas_servers %}
        <div class="card border-{{ 'success' if server.status == 'online' else 'error' }}">
            <div class="card-body p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">{{ server.get_icon() }}</span>
                    <div>
                        <div class="font-bold">{{ server.name }}</div>
                        <div class="text-xs text-muted">{{ server.host }}</div>
                    </div>
                </div>
                <div class="badge badge-{{ 'success' if server.status == 'online' else 'error' }} badge-sm">
                    {{ server.status|upper }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card border-dashed p-6 text-center">
        <p class="text-muted mb-2">Nenhum servidor NAS configurado.</p>
        <a href="{{ url_for('admin.file_server_new') }}" class="btn btn-sm btn-primary">+ Adicionar Servidor</a>
    </div>
    {% endif %}
</div>

<!-- 3. SE√á√ÉO DO ES-SERVIDOR (Condicional) -->
{% if has_active_esservidor %}
<div class="mb-8">
    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
        üìÇ Gest√£o ES-SERVIDOR
    </h2>

    <div class="dashboard-grid">
        <!-- Status ES-SERVIDOR -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Status do Servidor</h3>
            </div>
            <div class="card-body">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-3 h-3 rounded-full bg-{{ 'success' if esservidor_online else 'error' }}"></div>
                    <span class="font-bold">{{ 'Online' if esservidor_online else 'Offline' }}</span>
                </div>
                <p class="text-sm text-muted">IP: <code>{{ esservidor_ip }}</code></p>

                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="text-center p-2 bg-surface-alt rounded">
                        <div class="text-xs text-muted">Usu√°rios</div>
                        <div class="font-bold text-lg">{{ server_stats.total_users }}</div>
                    </div>
                    <div class="text-center p-2 bg-surface-alt rounded">
                        <div class="text-xs text-muted">Shares</div>
                        <div class="font-bold text-lg">{{ server_stats.shares }}</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Activity Chart -->
        <div class="card col-span-2">
            <div class="card-header">
                <h3 class="card-title">üìä Atividade de Arquivos</h3>
                <a href="{{ url_for('admin.audit_logs') }}" class="btn btn-sm btn-outline">Logs ‚Üí</a>
            </div>
            <div class="card-body" style="height: 250px;">
                <canvas id="actionsChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
{% if has_active_esservidor %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart data from Flask
    const SCD = {{ server_chart_data | tojson }};

    if (SCD.labels && SCD.labels.length > 0) {
        const ctxActions = document.getElementById('actionsChart').getContext('2d');
        new Chart(ctxActions, {
            type: 'bar',
            data: {
                labels: SCD.labels,
                datasets: [{
                    label: 'Opera√ß√µes',
                    data: SCD.action_counts,
                    backgroundColor: [
                        'rgba(6, 182, 212, 0.6)',
                        'rgba(245, 158, 11, 0.6)',
                        'rgba(16, 185, 129, 0.6)',
                        'rgba(239, 68, 68, 0.6)',
                        'rgba(107, 114, 128, 0.6)'
                    ],
                    borderColor: [
                        '#06b6d4', '#f59e0b', '#10b981', '#ef4444', '#6b7280'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>
{% endif %}
{% endblock %}