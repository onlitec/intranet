{% extends "base.html" %}

{% block title %}Logs de Acesso Internet{% endblock %}
{% block page_title %}Logs de Acesso Internet{% endblock %}
{% block page_subtitle %}Hist√≥rico detalhado de navega√ß√£o e auditoria de tr√°fego{% endblock %}

{% block content %}
<!-- Filtros Avan√ßados - Layout Ultra-Compacto -->
<form method="GET" class="filters-bar">
    <div class="filter-group">
        <label for="filter_ip">Dispositivo</label>
        <input id="filter_ip" type="text" name="ip" class="form-control" placeholder="IP/Hostname"
            value="{{ filters.ip }}">
    </div>
    <div class="filter-group">
        <label for="filter_site">Dom√≠nio</label>
        <input id="filter_site" type="text" name="site" class="form-control" placeholder="google.com"
            value="{{ filters.site }}">
    </div>
    <div class="filter-group">
        <label for="filter_date_from">In√≠cio</label>
        <input id="filter_date_from" type="date" name="date_from" class="form-control" value="{{ filters.date_from }}">
    </div>
    <div class="filter-group">
        <label for="filter_date_to">Fim</label>
        <input id="filter_date_to" type="date" name="date_to" class="form-control" value="{{ filters.date_to }}">
    </div>
    <div class="filter-actions">
        <button type="submit" class="btn btn-primary btn-sm">üîç Filtrar</button>
    </div>
</form>

<!-- Tabela de Auditoria -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Hist√≥rico de Conex√µes Hoje</h3>
        <div class="topbar-status">
            <span class="status-dot"></span>
            <span>Atualiza√ß√£o em tempo real</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>üïí Data e Hora</th>
                        <th>üíª Dispositivo</th>
                        <th>üåê Website / Destino</th>
                        <th>‚åõ Dura√ß√£o</th>
                        <th>üõ°Ô∏è Status</th>
                        <th class="text-right">üõ†Ô∏è Gest√£o</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs.items %}
                    {% set device_identifier = log.mac_address or log.ip_address or log.hostname %}
                    <tr {% if device_identifier %}class="row-clickable"
                        onclick="if(!event.target.closest('.btn-action')) window.location='{{ url_for('admin.device_analytics', mac=log.mac_address) if log.mac_address else url_for('admin.monitoring_device_details', identifier=device_identifier) }}'"{% endif %}>
                        <td class="timestamp-badge">
                            {{ log.timestamp|localdatetime|strftime('%d/%m/%Y') }}<br>
                            <span class="text-lg font-bold text-primary">{{
                                log.timestamp|localdatetime|strftime('%H:%M:%S') }}</span>
                        </td>
                        <td>
                            <div class="log-device">
                                <div class="device-icon">
                                    {% set category = known_devices.get(log.mac_address) %}
                                    {% if category == 'pc' %}üíª
                                    {% elif category == 'smartphone' %}üì±
                                    {% elif category == 'camera' %}üì∑
                                    {% elif category == 'pabx' %}‚òéÔ∏è
                                    {% elif category == 'server' %}üñ•Ô∏è
                                    {% elif category == 'other' %}üîå
                                    {% elif log.hostname and 'DESKTOP' in log.hostname %}üíª
                                    {% elif log.hostname and 'SMARTPHONE' in log.hostname %}üì±
                                    {% else %}üíª{% endif %}
                                </div>
                                <div>
                                    <div class="font-bold flex items-center gap-2">
                                        {% if log.hostname %}
                                        {{ log.hostname }}
                                        {% if log.mac_address %}<span
                                            class="badge badge-primary badge-xs">Known</span>{% endif %}
                                        {% elif log.mac_address %}
                                        {{ log.mac_address }} <span class="text-muted text-xs">({{ log.ip_address
                                            }})</span>
                                        {% else %}
                                        {{ log.ip_address }}
                                        {% endif %}
                                    </div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <code class="text-xs">{{ log.ip_address }}</code>
                                        {% if log.mac_address %}
                                        <a href="{{ url_for('admin.device_analytics', mac=log.mac_address) }}"
                                            class="btn-action text-accent hover:underline">
                                            <code class="text-xs">{{ log.mac_address }}</code>
                                        </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="log-site">
                                <span class="site-icon">üîó</span>
                                <div class="domain-text" title="{{ log.full_url or log.website }}">
                                    {{ log.website }}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-secondary">{{ log.duration or '0' }}s</span>
                        </td>
                        <td>
                            {% if log.action == 'allowed' %}
                            <span class="badge badge-success">‚úÖ Permitido</span>
                            {% else %}
                            <span class="badge badge-error">üö´ Bloqueado</span>
                            {% endif %}
                        </td>
                        <td class="text-right">
                            <div class="flex justify-end gap-2">
                                <a href="{{ url_for('admin.device_analytics', mac=log.mac_address if log.mac_address else 'none') }}"
                                    class="btn-action btn btn-xs btn-outline" title="An√°lise IA">üß†</a>
                                {% if log.mac_address and not (log.mac_address in known_devices) %}
                                <button onclick="openQuickRegister('{{ log.mac_address }}')"
                                    class="btn-action btn btn-xs btn-primary font-bold" title="Cadastrar">+üìù</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center p-12">
                            <div class="text-4xl mb-4">üîé</div>
                            <div class="text-lg font-bold">Nenhum registro encontrado</div>
                            <p class="text-muted">Tente ajustar seus filtros para encontrar o que procura.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagina√ß√£o e Modal -->
    <div id="quick-register-modal" class="modal">
        <div class="modal-content card">
            <div class="card-header border-b border-surface-alt flex justify-between items-center bg-surface-alt">
                <h3 class="card-title">üöÄ Cadastro R√°pido de Dispositivo</h3>
                <button onclick="closeModal()" class="btn-icon">√ó</button>
            </div>
            <div class="card-body">
                <form id="quick-reg-form">
                    <input type="hidden" id="reg-mac" name="mac_address">
                    <div class="form-group mb-4">
                        <label class="form-label text-xs uppercase text-muted">MAC Detectado</label>
                        <input type="text" id="reg-mac-display" class="form-control" disabled style="opacity: 0.6">
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">Nome p/ Identifica√ß√£o</label>
                        <input type="text" id="reg-hostname" class="form-control" placeholder="Ex: PC-SALA-FINANC"
                            required>
                    </div>
                    <div class="form-group mb-4">
                        <label class="form-label">Categoria</label>
                        <select id="reg-category" class="form-control">
                            <option value="pc">üíª Computador</option>
                            <option value="smartphone">üì± Smartphone</option>
                            <option value="server">üñ•Ô∏è Servidor</option>
                            <option value="other">üîå Outro</option>
                        </select>
                    </div>
                    <button type="button" onclick="submitQuickRegister()"
                        class="btn btn-accent w-full mt-4 font-bold py-3">Salvar na Rede</button>
                </form>
            </div>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .modal-content {
            margin: 12% auto;
            width: 420px;
            border: 2px solid var(--accent);
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-muted);
            cursor: pointer;
            line-height: 1;
        }

        .btn-xs {
            padding: 4px 8px;
            font-size: 10px;
        }

        .btn-action {
            position: relative;
            z-index: 10;
        }
    </style>

    <script>
        function openQuickRegister(mac) {
            document.getElementById('reg-mac').value = mac;
            document.getElementById('reg-mac-display').value = mac;
            document.getElementById('quick-register-modal').style.display = 'block';
        }
        function closeModal() { document.getElementById('quick-register-modal').style.display = 'none'; }
        function submitQuickRegister() {
            const mac = document.getElementById('reg-mac').value;
            const hostname = document.getElementById('reg-hostname').value;
            const category = document.getElementById('reg-category').value;
            if (!hostname) return alert('Por favor, informe um nome.');
            const fd = new FormData();
            fd.append('mac_address', mac);
            fd.append('hostname', hostname);
            fd.append('category', category);
            fetch("{{ url_for('admin.device_quick_register') }}", {
                method: 'POST',
                headers: { 'X-CSRFToken': "{{ csrf_token() }}" },
                body: fd
            }).then(r => r.json()).then(data => {
                if (data.success) { location.reload(); } else { alert(data.message); }
            });
        }
    </script>

    <!-- Pagina√ß√£o Profissional -->
    <div class="card-footer pagination-footer">
        <div class="text-muted text-sm font-medium">
            Mostrando <strong>{{ (logs.page - 1) * logs.per_page + 1 if logs.total > 0 else 0 }}</strong> a <strong>{{
                (logs.page - 1) * logs.per_page + logs.items|length }}</strong> de <strong>{{ logs.total }}</strong>
            logs
        </div>
        <div class="flex items-center gap-2">
            {% if logs.has_prev %}
            <a href="{{ url_for('admin.monitoring_logs', page=logs.prev_num, **filters) }}"
                class="btn btn-secondary btn-sm">
                ‚Üê Anterior
            </a>
            {% endif %}

            <div class="flex items-center px-4 py-2 font-bold text-sm bg-card border rounded-md">
                P√°gina {{ logs.page }} / {{ logs.pages }}
            </div>

            {% if logs.has_next %}
            <a href="{{ url_for('admin.monitoring_logs', page=logs.next_num, **filters) }}"
                class="btn btn-secondary btn-sm">
                Pr√≥ximo ‚Üí
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}