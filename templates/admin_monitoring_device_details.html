{% extends "base.html" %}

{% block title %}Detalhes do Dispositivo - {{ device.hostname or identifier }}{% endblock %}
{% block page_title %}Monitoramento: Dispositivo{% endblock %}
{% block page_subtitle %}
<p class="topbar-subtitle">Hist√≥rico de acessos para <strong>{{ device.hostname or identifier }}</strong>{% if
    (device.ip_address or device.temp_ip) and (device.hostname != (device.ip_address or device.temp_ip)) %} <span
        class="text-muted">({{ device.ip_address or device.temp_ip }})</span>{% endif %}</p>
{% endblock %}

{% block content %}
<!-- AI Insight Report -->
<div class="card ai-card mb-6">
    <div class="card-header ai-header">
        <h3 class="card-title text-white">‚ú® An√°lise Inteligente da Navega√ß√£o</h3>
        <span class="badge badge-ai">BETA</span>
    </div>
    <div class="card-body ai-body">
        <div class="ai-content">
            {{ ai_summary|safe if ai_summary else 'Iniciando an√°lise inteligente...' }}
        </div>
    </div>
</div>

<!-- Device Info & Stats Summary -->
<div class="stats-grid mb-6">
    <div class="stat-card stat-primary">
        <div class="stat-icon primary">{{ device.get_icon() }}</div>
        <div class="stat-info">
            <div class="stat-value">{{ total_requests }}</div>
            <div class="stat-label">Total de Requisi√ß√µes</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon info">üåê</div>
        <div class="stat-info">
            <div class="stat-value">{{ top_sites|length }}</div>
            <div class="stat-label">Dom√≠nios Diferentes</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon warning">üïí</div>
        <div class="stat-info">
            <div class="stat-value">Hoje</div>
            <div class="stat-label">Atividade Recente</div>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Top Sites for this Device -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üåê Sites Mais Acessados</h3>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Site/Dom√≠nio</th>
                            <th style="text-align: right;">Acessos</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if top_sites %}
                        {% set dev_ip = device.ip_address or device.temp_ip or identifier %}
                        {% set dev_host = device.hostname if device.hostname != 'Dispositivo Desconhecido' else '' %}
                        {% for site in top_sites %}
                        <tr class="row-clickable"
                            onclick="window.location='{{ url_for('admin.monitoring_logs', site=site.website, ip=dev_ip, hostname=dev_host) }}'">
                            <td>{{ site.website }}</td>
                            <td style="text-align: right;"><strong>{{ site.hit_count }}</strong></td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-center">Nenhum dado dispon√≠vel</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Device Identity -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">üÜî Informa√ß√µes do Dispositivo</h3>
        </div>
        <div class="card-body">
            <div class="info-list">
                <div class="info-item"
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="text-muted">Hostname:</span>
                    <span class="fw-600">{{ device.hostname or 'N/A' }}</span>
                </div>
                <div class="info-item"
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="text-muted">Endere√ßo IP:</span>
                    <span class="fw-600"><code>{{ device.ip_address or identifier }}</code></span>
                </div>
                <div class="info-item"
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="text-muted">MAC Address:</span>
                    <span class="fw-600"><code>{{ device.mac_address or 'Desconhecido' }}</code></span>
                </div>
                <div class="info-item"
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="text-muted">Uptime:</span>
                    <span class="fw-600">{{ device.uptime or 'N/A' }}</span>
                </div>
                <div class="info-item"
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="text-muted">Usu√°rio Logado:</span>
                    <span class="fw-600">{{ device.user_domain + '\' if device.user_domain }}{{ device.logged_user or
                        '---' }}</span>
                </div>
                {% if device.login_time %}
                <div class="info-item"
                    style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);">
                    <span class="text-muted">Login em:</span>
                    <span class="fw-600">{{ device.login_time|localdatetime|strftime('%d/%m %H:%M') }}</span>
                </div>
                {% endif %}
                <div class="info-item" style="display: flex; justify-content: space-between; padding: 12px 0;">
                    <span class="text-muted">Categoria:</span>
                    <span class="badge badge-info">{{ device.category|capitalize }}</span>
                </div>
            </div>
            <div class="mt-4">
                {% set dev_ip = device.ip_address or device.temp_ip or identifier %}
                {% set dev_host = device.hostname if device.hostname != 'Dispositivo Desconhecido' else '' %}
                <a href="{{ url_for('admin.monitoring_logs', ip=dev_ip, hostname=dev_host) }}"
                    class="btn btn-primary w-100">
                    üîç Ver Todos os Logs Detalhados
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Multi-module Tabs for Detailed Data (V2) -->
<div class="card mt-6">
    <div class="card-header border-b border-surface-alt bg-surface-alt" style="padding: 0;">
        <div class="flex">
            <button onclick="switchTab('logs')" id="tab-btn-logs"
                class="px-6 py-4 font-bold border-b-2 border-accent text-accent">üìã Logs Recentes</button>
            <button onclick="switchTab('inventory')" id="tab-btn-inventory"
                class="px-6 py-4 font-bold border-b-2 border-transparent hover:text-accent">üì¶ Invent√°rio</button>
            <button onclick="switchTab('realtime')" id="tab-btn-realtime"
                class="px-6 py-4 font-bold border-b-2 border-transparent hover:text-accent">‚ö° Processos
                Real-time</button>
        </div>
    </div>

    <!-- Tab CONTENT: Logs -->
    <div id="tab-logs" class="tab-pane">
        <div class="card-body" style="padding: 0;">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Hor√°rio</th>
                            <th>Website</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_logs %}
                        <tr>
                            <td style="white-space: nowrap; font-size: var(--text-xs);">
                                {{ log.timestamp|localdatetime|strftime('%d/%m %H:%M:%S') }}
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 400px;" title="{{ log.website }}">
                                    {{ log.website }}
                                </div>
                            </td>
                            <td>
                                {% if log.action == 'allowed' %}
                                <span class="badge badge-success">Permitido</span>
                                {% else %}
                                <span class="badge badge-error">Bloqueado</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab CONTENT: Inventory -->
    <div id="tab-inventory" class="tab-pane" style="display: none;">
        <div class="card-body p-0">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome do Software</th>
                            <th>Vers√£o</th>
                            <th>Fabricante</th>
                            <th>Instala√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in inventory %}
                        <tr>
                            <td class="font-bold">{{ item.name }}</td>
                            <td><code>{{ item.version or '---' }}</code></td>
                            <td>{{ item.publisher or '---' }}</td>
                            <td class="text-xs text-muted">{{ item.install_date or '---' }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center p-8 text-muted italic">Nenhum software inventariado para
                                este computador.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Tab CONTENT: Realtime (Direct Fetch to Agent Port 9090) -->
    <div id="tab-realtime" class="tab-pane" style="display: none;">
        <div class="card-body">
            <div id="realtime-status-banner" class="alert alert-info mb-4"
                style="display: flex; align-items: center; gap: 10px;">
                <div class="spinner-small"></div>
                <span>Conectando √† API Local do Agente em
                    <code>{{ device.last_ip or device.temp_ip or identifier }}:9090</code>...</span>
            </div>

            <div id="realtime-error" class="alert alert-warning mb-4" style="display: none;">
                <strong>‚ö†Ô∏è Conex√£o Local Falhou:</strong> N√£o foi poss√≠vel acessar a API do agente diretamente desta
                rede.
                Certifique-se que o Agente V2 est√° rodando e a porta 9090 est√° aberta para esta esta√ß√£o.
            </div>

            <div class="table-container" id="realtime-table-wrapper" style="display: none;">
                <table class="data-table" id="realtime-table">
                    <thead>
                        <tr>
                            <th>Processo</th>
                            <th>CPU</th>
                            <th>Mem√≥ria</th>
                            <th>Usu√°rio</th>
                            <th>Caminho</th>
                        </tr>
                    </thead>
                    <tbody id="realtime-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .fw-600 {
        font-weight: 600;
    }

    .mt-4 {
        margin-top: 1rem;
    }

    .mt-6 {
        margin-top: 1.5rem;
    }

    .mb-6 {
        margin-bottom: 1.5rem;
    }

    .w-100 {
        width: 100%;
    }

    .spinner-small {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: var(--accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<script>
    function switchTab(tabId) {
        // Hide all panes
        document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
        // Deactivate all buttons
        document.querySelectorAll('[id^="tab-btn-"]').forEach(b => {
            b.classList.remove('border-accent', 'text-accent');
            b.classList.add('border-transparent');
        });

        // Show selected
        document.getElementById('tab-' + tabId).style.display = 'block';
        const activeBtn = document.getElementById('tab-btn-' + tabId);
        activeBtn.classList.remove('border-transparent');
        activeBtn.classList.add('border-accent', 'text-accent');

        if (tabId === 'realtime') {
            refreshRealtime();
        }
    }

    let realtimeInterval = null;

    async function refreshRealtime() {
        const ip = "{{ device.last_ip or device.temp_ip or identifier }}";
        const banner = document.getElementById('realtime-status-banner');
        const errorDiv = document.getElementById('realtime-error');
        const tableWrapper = document.getElementById('realtime-table-wrapper');
        const tbody = document.getElementById('realtime-tbody');

        try {
            // Tentativa de conex√£o direta (o browser do admin tenta falar com o PC alvo)
            const response = await fetch(`http://${ip}:9090/proc/list`, {
                mode: 'cors',
                signal: AbortSignal.timeout(5000)
            });

            if (!response.ok) throw new Error('Falha na resposta do agente');

            const data = await response.json();
            banner.style.display = 'none';
            errorDiv.style.display = 'none';
            tableWrapper.style.display = 'block';

            tbody.innerHTML = '';
            data.processes.sort((a, b) => b.cpu - a.cpu).slice(0, 15).forEach(proc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-bold">${proc.name}</td>
                    <td><span class="badge ${proc.cpu > 50 ? 'badge-error' : 'badge-primary'}">${proc.cpu}%</span></td>
                    <td class="text-xs text-muted">${proc.memory_mb} MB</td>
                    <td class="text-xs">${proc.username}</td>
                    <td class="text-xs opacity-50"><code style="font-size: 0.6rem;">${proc.path}</code></td>
                `;
                tbody.appendChild(tr);
            });

        } catch (err) {
            banner.style.display = 'none';
            tableWrapper.style.display = 'none';
            errorDiv.style.display = 'block';
            console.error('Realtime fetch error:', err);
        }
    }
</script>
{% endblock %}