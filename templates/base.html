<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Intranet Corporativa ES-SERVIDOR - Gerenciamento Profissional">
    <meta name="author" content="{{ settings.site_title }}">
    <title>{% block title %}Intranet{% endblock %} - {{ settings.site_title }}</title>

    <!-- Google Fonts: Plus Jakarta Sans (Enterprise UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- CSS (Version Bump for Cache Busting) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=20260201_v8">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ settings.site_favicon }}">

    {% block extra_head %}{% endblock %}
</head>

<body class="{% block body_class %}app-layout{% endblock %}">
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    {% block body %}
    {% from "_icons.html" import icon %}

    <!-- Sidebar -->
    <aside class="sidebar" id="app-sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('admin.dashboard') if session.get('is_admin') else url_for('dashboard') if current_user.is_authenticated else url_for('home') }}"
                class="sidebar-logo">
                <img src="{{ settings.site_logo }}" alt="Logo" onerror="this.style.display='none'">
                <div class="logo-meta">
                    <span class="logo-text">{{ settings.site_title }}</span>
                    <span class="logo-badge">ENTERPRISE</span>
                </div>
            </a>
        </div>

        <nav class="sidebar-nav">
            {% if session.get('is_admin') %}
            <div class="nav-section">
                <div class="nav-section-title">Monitoramento de Internet</div>
                <a href="{{ url_for('admin.monitoring_dashboard') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_dashboard' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('activity') }}</span>
                    <span>Painel Geral</span>
                </a>

                <!-- Dispositivos with Submenu -->
                <div class="nav-item nav-item-expandable {% if request.endpoint in ['admin.monitoring_devices_overview', 'admin.monitoring_device_details', 'admin.monitoring_productivity_device_details', 'admin.monitoring_report_productivity', 'admin.monitoring_logs'] %}expanded{% endif %}"
                    id="devices-menu" onclick="toggleSubmenu('devices-menu', 'devices-submenu')">
                    <span class="nav-icon">üì±</span>
                    <span>Dispositivos</span>
                </div>
                <div class="nav-submenu {% if request.endpoint in ['admin.monitoring_devices_overview', 'admin.monitoring_device_details', 'admin.monitoring_productivity_device_details', 'admin.monitoring_report_productivity', 'admin.monitoring_logs'] %}expanded{% endif %}"
                    id="devices-submenu">
                    <a href="{{ url_for('admin.monitoring_devices_overview') }}"
                        class="nav-subitem {% if request.endpoint in ['admin.monitoring_devices_overview', 'admin.monitoring_device_details', 'admin.monitoring_productivity_device_details'] %}active{% endif %}">
                        <span>Vis√£o Geral</span>
                    </a>
                    <a href="{{ url_for('admin.monitoring_logs') }}"
                        class="nav-subitem {% if request.endpoint == 'admin.monitoring_logs' %}active{% endif %}">
                        <span>Logs de Acesso</span>
                    </a>
                    <a href="{{ url_for('admin.monitoring_report_productivity') }}"
                        class="nav-subitem {% if request.endpoint == 'admin.monitoring_report_productivity' %}active{% endif %}">
                        <span>Produtividade</span>
                    </a>
                </div>

                <a href="{{ url_for('admin.monitoring_devices') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_devices' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('cpu') }}</span>
                    <span>Invent√°rio de Rede</span>
                </a>
                <a href="{{ url_for('admin.monitoring_network_map') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_network_map' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('layers') }}</span>
                    <span>Mapa de Rede</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Monitoramento NAS</div>
                <a href="{{ url_for('admin.dashboard') }}"
                    class="nav-item {% if request.endpoint == 'admin.dashboard' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('dashboard') }}</span>
                    <span>Vis√£o Geral</span>
                </a>
                <a href="{{ url_for('admin.file_servers') }}"
                    class="nav-item {% if request.endpoint in ['admin.file_servers', 'admin.file_server_new', 'admin.file_server_edit'] %}active{% endif %}">
                    <span class="nav-icon">{{ icon('server') }}</span>
                    <span>Servidores de Arquivos</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">GERENCIAMENTO</div>
                <a href="{{ url_for('admin.users_list') }}"
                    class="nav-item {% if request.endpoint in ['admin.users_list', 'admin.users_new', 'admin.users_edit'] %}active{% endif %}">
                    <span class="nav-icon">{{ icon('users') }}</span>
                    <span>Usu√°rios</span>
                </a>
                <a href="{{ url_for('admin.shares') }}"
                    class="nav-item {% if request.endpoint == 'admin.shares' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('folder') }}</span>
                    <span>Compartilhamentos</span>
                </a>
                <a href="{{ url_for('admin.storage') }}"
                    class="nav-item {% if request.endpoint == 'admin.storage' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('storage') }}</span>
                    <span>Armazenamento</span>
                </a>
                <a href="{{ url_for('admin.remote_sessions') }}"
                    class="nav-item {% if request.endpoint == 'admin.remote_sessions' %}active{% endif %}">
                    <span class="nav-icon">üì¢</span>
                    <span>Acesso Remoto</span>
                </a>
            </div>


            <div class="nav-section">
                <div class="nav-section-title">Sistema</div>
                <a href="{{ url_for('admin.platform_settings') }}"
                    class="nav-item {% if request.endpoint == 'admin.platform_settings' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('settings') }}</span>
                    <span>Configura√ß√µes</span>
                </a>
            </div>
            {% elif current_user.is_authenticated %}
            <div class="nav-section">
                <div class="nav-section-title">Acesso R√°pido</div>
                <a href="{{ url_for('dashboard') }}"
                    class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('folder') }}</span>
                    <span>Meus Arquivos</span>
                </a>
            </div>
            {% endif %}
        </nav>

        <div class="sidebar-footer">
            <div class="user-pill-container">
                <div class="user-pill">
                    {% if session.get('is_admin') %}
                    <span class="user-avatar" title="Administrador">A</span>
                    <div class="user-details">
                        <span class="user-name-small">{{ session.get('admin_name', 'Admin') }}</span>
                    </div>
                    {% elif current_user.is_authenticated %}
                    <span class="user-avatar">{{ current_user.full_name[0] }}</span>
                    <div class="user-details">
                        <span class="user-name-small">{{ current_user.full_name }}</span>
                    </div>
                    {% endif %}
                </div>

                <div class="footer-actions">
                    <button id="theme-toggle" class="btn-icon-small" title="Mudar Tema">
                        <span class="icon-sun">{{ icon('sun') }}</span>
                        <span class="icon-moon">{{ icon('moon') }}</span>
                    </button>

                    {% if session.get('is_admin') %}
                    <form action="{{ url_for('admin.logout') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="logout-btn-minimal" title="Sair do Sistema">{{ icon('logout')
                            }}</button>
                    </form>
                    {% elif current_user.is_authenticated %}
                    <form action="{{ url_for('do_logout') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="logout-btn-minimal" title="Sair do Sistema">{{ icon('logout')
                            }}</button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </aside>

    <!-- Mobile Dock -->
    <nav class="mobile-dock">
        {% if session.get('is_admin') %}
        <a href="{{ url_for('admin.dashboard') }}" class="dock-item">
            {{ icon('dashboard') }}
            <span>Home</span>
        </a>
        <a href="{{ url_for('admin.monitoring_dashboard') }}" class="dock-item">
            {{ icon('activity') }}
            <span>Internet</span>
        </a>
        <a href="{{ url_for('admin.storage') }}" class="dock-item">
            {{ icon('storage') }}
            <span>Storage</span>
        </a>
        {% else %}
        <a href="{{ url_for('dashboard') }}" class="dock-item">
            {{ icon('folder') }}
            <span>Arquivos</span>
        </a>
        {% endif %}
        <button id="theme-toggle-mobile" class="dock-item">
            {{ icon('sun') }}
        </button>
    </nav>

    <div class="main-wrapper">
        <header class="topbar-modern">
            <div class="topbar-left">
                <div class="page-meta">
                    <h1 class="page-title">{% block page_title %}P√°gina Inicial{% endblock %}</h1>
                    <div class="server-status-badge" id="server-status">
                        <span class="status-dot"></span>
                        <span id="status-text">CARREGANDO</span>
                    </div>
                </div>
            </div>
            <div class="topbar-right">
                {% block page_actions %}{% endblock %}
            </div>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-stack">
            {% for category, message in messages %}
            <div class="flash-toast flash-{{ category }}">
                <p>{{ message }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <main class="content-area">
            {% block content %}{% endblock %}
        </main>
    </div>
    {% endblock %}

    <script>
        // Submenu toggle functionality
        const toggleSubmenu = (menuId, submenuId) => {
            const menu = document.getElementById(menuId);
            const submenu = document.getElementById(submenuId);

            menu.classList.toggle('expanded');
            submenu.classList.toggle('expanded');

            // Save state to localStorage
            const isExpanded = menu.classList.contains('expanded');
            localStorage.setItem(`submenu_${menuId}`, isExpanded);
        };

        const initTheme = () => {
            const toggles = document.querySelectorAll('#theme-toggle, #theme-toggle-mobile');
            toggles.forEach(btn => btn.addEventListener('click', () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
            }));
        };

        const checkStatus = () => {
            const statusEl = document.getElementById('server-status');
            const textEl = document.getElementById('status-text');
            if (statusEl) {
                fetch('/api/status').then(r => r.json()).then(data => {
                    statusEl.classList.toggle('online', !!data.monitoring_engine);
                    textEl.textContent = data.monitoring_engine ? 'ONLINE' : 'OFFLINE';
                }).catch(() => {
                    statusEl.classList.add('error');
                    textEl.textContent = 'ERRO';
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            checkStatus();
        });
    </script>
    {% block extra_scripts %}{% endblock %}
</body>

</html>