<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Intranet Corporativa ES-SERVIDOR - Sistema de Gerenciamento">
    <meta name="author" content="{{ settings.site_title }}">
    <title>{% block title %}Intranet{% endblock %} - {{ settings.site_title }}</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{{ settings.site_favicon }}">

    {% block extra_head %}{% endblock %}
</head>

<body class="{% block body_class %}app-layout{% endblock %}">
    {% block body %}
    {% from "_icons.html" import icon %}
    <!-- Sidebar -->
    <aside class="sidebar" id="app-sidebar">
        <div class="sidebar-header">
            <a href="{{ url_for('home') }}" class="sidebar-logo">
                <img src="{{ settings.site_logo }}" alt="Logo" onerror="this.style.display='none'">
                <div>
                    <div class="sidebar-logo-text">{{ settings.site_title }}</div>
                    <div class="sidebar-logo-subtitle">Intranet</div>
                </div>
            </a>
        </div>

        <nav class="sidebar-nav">
            {% if session.get('is_admin') %}
            <!-- Admin Navigation -->
            <div class="nav-section">
                <div class="nav-section-title">üìÇ Servidor de Arquivos</div>
                <a href="{{ url_for('admin.dashboard') }}"
                    class="nav-item {% if request.endpoint == 'admin.dashboard' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('dashboard') }}</span>
                    <span>Dashboard Geral</span>
                </a>
                <a href="{{ url_for('admin.storage') }}"
                    class="nav-item {% if request.endpoint == 'admin.storage' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('storage') }}</span>
                    <span>Armazenamento</span>
                </a>
                <a href="{{ url_for('admin.shares') }}"
                    class="nav-item {% if request.endpoint == 'admin.shares' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('folder') }}</span>
                    <span>Compartilhamentos</span>
                </a>
                <a href="{{ url_for('admin.server_users') }}"
                    class="nav-item {% if request.endpoint == 'admin.server_users' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('users') }}</span>
                    <span>Usu√°rios Servidor</span>
                </a>
                <a href="{{ url_for('admin.users_list') }}"
                    class="nav-item {% if request.endpoint in ['admin.users_list', 'admin.users_new', 'admin.users_edit'] %}active{% endif %}">
                    <span class="nav-icon">{{ icon('users') }}</span>
                    <span>Usu√°rios Intranet</span>
                </a>
                <a href="{{ url_for('admin.audit_logs') }}"
                    class="nav-item {% if request.endpoint == 'admin.audit_logs' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('search') }}</span>
                    <span>Auditoria de Arquivos</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">üåê Controle de Internet</div>
                <a href="{{ url_for('admin.monitoring_dashboard') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_dashboard' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('activity') }}</span>
                    <span>Painel de Tr√°fego</span>
                </a>
                <a href="{{ url_for('admin.monitoring_logs') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_logs' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('fileText') }}</span>
                    <span>Logs de Acesso</span>
                </a>
                <a href="{{ url_for('admin.monitoring_devices') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_devices' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('monitor') }}</span>
                    <span>Dispositivos Conhecidos</span>
                </a>
                <a href="{{ url_for('admin.monitoring_sources') }}"
                    class="nav-item {% if request.endpoint == 'admin.monitoring_sources' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('storage') }}</span>
                    <span>Fontes de Dados</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">‚öôÔ∏è Ajustes & Sistema</div>
                <a href="{{ url_for('admin.platform_settings') }}"
                    class="nav-item {% if request.endpoint == 'admin.platform_settings' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('settings') }}</span>
                    <span>Customiza√ß√£o</span>
                </a>
                <a href="{{ url_for('admin.report_schedules') }}"
                    class="nav-item {% if request.endpoint in ['admin.report_schedules', 'admin.reports_new'] %}active{% endif %}">
                    <span class="nav-icon">{{ icon('calendar') }}</span>
                    <span>Relat√≥rios Agendados</span>
                </a>
                <a href="{{ url_for('admin.admins_list') }}"
                    class="nav-item {% if request.endpoint in ['admin.admins_list', 'admin.admins_new', 'admin.admins_edit'] %}active{% endif %}">
                    <span class="nav-icon">{{ icon('shield') }}</span>
                    <span>Administradores</span>
                </a>
                <a href="{{ url_for('admin.smtp_settings') }}"
                    class="nav-item {% if request.endpoint == 'admin.smtp_settings' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('mail') }}</span>
                    <span>Servidor E-mail</span>
                </a>
                <a href="{{ url_for('admin.logs') }}"
                    class="nav-item {% if request.endpoint == 'admin.logs' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('fileText') }}</span>
                    <span>Logs do Sistema</span>
                </a>
            </div>

            {% elif current_user.is_authenticated %}
            <!-- User Navigation -->
            <div class="nav-section">
                <div class="nav-section-title">Menu</div>
                <a href="{{ url_for('dashboard') }}"
                    class="nav-item {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    <span class="nav-icon">{{ icon('folder') }}</span>
                    <span>Meus Compartilhamentos</span>
                </a>
            </div>
            {% endif %}
        </nav>

        <div class="sidebar-footer">
            {% if session.get('is_admin') %}
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">A</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ session.get('admin_name', 'Admin') }}</div>
                    <div class="sidebar-user-role">Administrador</div>
                </div>
            </div>
            <form action="{{ url_for('admin.logout') }}" method="POST" style="margin-top: 12px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-ghost btn-block btn-sm"
                    style="justify-content: flex-start; color: var(--sidebar-text);">
                    {{ icon('logout') }} Sair
                </button>
            </form>
            {% elif current_user.is_authenticated %}
            <div class="sidebar-user">
                <div class="sidebar-user-avatar">{{ current_user.full_name[0] if current_user.full_name else 'U' }}
                </div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name">{{ current_user.full_name }}</div>
                    <div class="sidebar-user-role">Usu√°rio</div>
                </div>
            </div>
            <form action="{{ url_for('do_logout') }}" method="POST" style="margin-top: 12px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-ghost btn-block btn-sm"
                    style="justify-content: flex-start; color: var(--sidebar-text);">
                    {{ icon('logout') }} Sair
                </button>
            </form>
            {% endif %}
        </div>
    </aside>

    <!-- Sidebar Backdrop (mobile) -->
    <div class="sidebar-backdrop" id="sidebar-backdrop" hidden></div>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <!-- Topbar -->
        <header class="topbar">
            <div class="topbar-left">
                <button type="button" class="sidebar-toggle" aria-label="Abrir menu" aria-controls="app-sidebar"
                    aria-expanded="false">
                    <span class="sidebar-toggle-icon" aria-hidden="true">‚ò∞</span>
                </button>
                <div>
                    <h1 class="topbar-title">{% block page_title %}Dashboard{% endblock %}</h1>
                    {% block page_subtitle %}<p class="topbar-subtitle">Vis√£o geral do sistema</p>{% endblock %}
                </div>
            </div>
            <div class="topbar-right">
                <div class="topbar-actions">
                    {% block page_actions %}{% endblock %}
                </div>
                <div id="server-status" class="topbar-status">
                    <span class="status-dot"></span>
                    <span id="status-text">Verificando...</span>
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-container" style="padding: 24px 24px 0;">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                <span class="alert-icon">
                    {% if category == 'success' %}‚úì{% elif category == 'error' %}‚úï{% elif category == 'warning' %}‚ö†{%
                    else %}‚Ñπ{% endif %}
                </span>
                <span class="alert-message">{{ message }}</span>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Main Content -->
        <main class="main-content">
            {% block content %}{% endblock %}
        </main>
    </div>
    {% endblock %}

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <!-- Server Status Check -->
    <script>
        (function () {
            const statusEl = document.getElementById('server-status');
            const textEl = document.getElementById('status-text');
            if (!statusEl || !textEl) return;

            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (data.monitoring_engine) {
                        statusEl.classList.remove('offline');
                        textEl.textContent = 'Monitoramento Online';
                        if (!data.esservidor_connection) {
                            textEl.title = 'Conex√£o ES-SERVIDOR falhou, mas Monitoramento OK';
                        }
                    } else {
                        statusEl.classList.add('offline');
                        textEl.textContent = 'Motor Offline';
                    }
                })
                .catch(() => {
                    statusEl.classList.add('offline');
                    textEl.textContent = 'Erro API';
                });
        })();
    </script>

    {% block extra_scripts %}{% endblock %}
</body>

</html>